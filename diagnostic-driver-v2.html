<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagnostic Compte Conducteur V2</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 {
      color: #1a1a1a;
      margin-bottom: 8px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 24px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      border-color: #2563eb;
    }
    button {
      width: 100%;
      padding: 14px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    button:hover {
      background: #1d4ed8;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .result {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.6;
    }
    .success {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #10b981;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #ef4444;
    }
    .info {
      background: #dbeafe;
      color: #1e40af;
      border: 2px solid #3b82f6;
    }
    .warning {
      background: #fef3c7;
      color: #92400e;
      border: 2px solid #f59e0b;
    }
    .section-title {
      font-weight: 700;
      color: #1e40af;
      margin: 16px 0 8px 0;
      font-size: 18px;
    }
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-ok { background: #10b981; }
    .status-error { background: #ef4444; }
    .status-warning { background: #f59e0b; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üîß Diagnostic Compte Conducteur V2</h1>
    <p class="subtitle">Version am√©lior√©e avec v√©rification de connexion au serveur</p>
    
    <div id="connectionStatus" style="padding: 12px; border-radius: 8px; margin-bottom: 20px;">
      <div style="font-weight: 600; margin-bottom: 8px;">√âtat du syst√®me :</div>
      <div id="statusList">
        <div>‚è≥ V√©rification en cours...</div>
      </div>
    </div>
    
    <div class="form-group">
      <label>Num√©ro de t√©l√©phone ou Email</label>
      <input 
        type="text" 
        id="identifier" 
        placeholder="Ex: 0812345678 ou 243812345678"
        value=""
      />
    </div>
    
    <button onclick="runFullDiagnostic()" id="diagBtn">üîç Lancer le diagnostic complet</button>
    
    <div id="results"></div>
  </div>

  <script type="module">
    let supabaseClient = null;
    let projectId = null;
    let publicAnonKey = null;

    async function initSupabase() {
      try {
        console.log('üîÑ Initialisation Supabase...');
        
        // Import dynamique
        const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
        const info = await import('./utils/supabase/info.js');
        
        projectId = info.projectId;
        publicAnonKey = info.publicAnonKey;
        
        console.log('üìä Config Supabase:');
        console.log('  - Project ID:', projectId);
        console.log('  - Anon Key pr√©sente:', !!publicAnonKey);
        console.log('  - Anon Key length:', publicAnonKey?.length);
        
        supabaseClient = createClient(
          `https://${projectId}.supabase.co`,
          publicAnonKey
        );
        
        window.supabaseClient = supabaseClient;
        window.projectId = projectId;
        window.publicAnonKey = publicAnonKey;
        
        return { success: true, projectId, publicAnonKey };
      } catch (error) {
        console.error('‚ùå Erreur init Supabase:', error);
        return { success: false, error: error.message };
      }
    }

    async function checkServerHealth() {
      try {
        console.log('üè• V√©rification sant√© du serveur...');
        
        const response = await fetch(
          `https://${projectId}.supabase.co/functions/v1/make-server-2eb02e52/health`,
          {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${publicAnonKey}`
            }
          }
        );

        const data = await response.json();
        console.log('‚úÖ Serveur r√©pond:', data);
        
        return { success: true, data };
      } catch (error) {
        console.error('‚ùå Erreur serveur:', error);
        return { success: false, error: error.message };
      }
    }

    async function runSystemChecks() {
      const statusList = document.getElementById('statusList');
      statusList.innerHTML = '';

      const addStatus = (text, status) => {
        const div = document.createElement('div');
        div.style.margin = '4px 0';
        div.innerHTML = `<span class="status-indicator status-${status}"></span>${text}`;
        statusList.appendChild(div);
      };

      // Check 1: Init Supabase
      addStatus('Chargement de Supabase...', 'warning');
      const initResult = await initSupabase();
      
      if (!initResult.success) {
        addStatus(`‚ùå Erreur Supabase: ${initResult.error}`, 'error');
        document.getElementById('connectionStatus').style.background = '#fee2e2';
        return { ready: false, error: 'Supabase non initialis√©' };
      }
      
      addStatus(`‚úÖ Supabase initialis√© (Project: ${initResult.projectId.substring(0, 8)}...)`, 'ok');

      // Check 2: Server health
      addStatus('V√©rification du serveur backend...', 'warning');
      const healthResult = await checkServerHealth();
      
      if (!healthResult.success) {
        addStatus(`‚ùå Serveur inaccessible: ${healthResult.error}`, 'error');
        document.getElementById('connectionStatus').style.background = '#fee2e2';
        return { ready: false, error: 'Serveur backend inaccessible' };
      }
      
      addStatus('‚úÖ Serveur backend op√©rationnel', 'ok');
      
      // Tout est OK
      document.getElementById('connectionStatus').style.background = '#d1fae5';
      return { ready: true };
    }

    // Ex√©cuter les checks au chargement
    runSystemChecks().then(result => {
      window.systemReady = result.ready;
      console.log('Syst√®me pr√™t:', result.ready);
    });

    window.initSupabase = initSupabase;
    window.checkServerHealth = checkServerHealth;
    window.runSystemChecks = runSystemChecks;
  </script>

  <script>
    function addResult(message, type = 'info') {
      const resultsDiv = document.getElementById('results');
      const resultDiv = document.createElement('div');
      resultDiv.className = `result ${type}`;
      resultDiv.textContent = message;
      resultsDiv.appendChild(resultDiv);
    }

    function addSection(title) {
      const resultsDiv = document.getElementById('results');
      const sectionDiv = document.createElement('div');
      sectionDiv.className = 'section-title';
      sectionDiv.textContent = title;
      resultsDiv.appendChild(sectionDiv);
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
    }

    function normalizePhoneNumber(phone) {
      const cleaned = phone.replace(/[\s\-+()]/g, '');
      
      if (cleaned.length === 9 && /^\d+$/.test(cleaned)) {
        return `243${cleaned}`;
      }
      
      if (cleaned.length === 10 && cleaned.startsWith('0')) {
        return `243${cleaned.substring(1)}`;
      }
      
      if (cleaned.length === 12 && cleaned.startsWith('243')) {
        return cleaned;
      }
      
      if (cleaned.length === 13 && cleaned.startsWith('2430')) {
        return `243${cleaned.substring(4)}`;
      }
      
      return phone;
    }

    function detectInputType(input) {
      const trimmed = input.trim();
      
      if (trimmed.includes('@')) {
        return 'email';
      }
      
      const cleaned = trimmed.replace(/[\s\-+()]/g, '');
      if (/^\d+$/.test(cleaned)) {
        return 'phone';
      }
      
      return 'unknown';
    }

    async function runFullDiagnostic() {
      clearResults();
      
      // V√©rifier que le syst√®me est pr√™t
      if (!window.systemReady) {
        addSection('‚ùå SYST√àME NON PR√äT');
        addResult(
          'Le syst√®me n\'est pas pr√™t. Causes possibles:\n\n' +
          '1. Le serveur backend n\'est pas d√©marr√©\n' +
          '2. Les variables Supabase ne sont pas configur√©es\n' +
          '3. Probl√®me de connexion r√©seau\n\n' +
          'V√©rifiez la console (F12) pour plus de d√©tails.',
          'error'
        );
        
        addSection('üîß SOLUTION ALTERNATIVE');
        addResult(
          'Vous pouvez chercher votre compte directement dans le backend.\n\n' +
          'M√©thode 1 - Via curl:\n' +
          'curl -X POST \\\n' +
          '  https://[PROJECT_ID].supabase.co/functions/v1/make-server-2eb02e52/diagnostic-driver \\\n' +
          '  -H "Content-Type: application/json" \\\n' +
          '  -H "Authorization: Bearer [ANON_KEY]" \\\n' +
          '  -d \'{"identifier": "VOTRE_NUMERO"}\'\n\n' +
          'M√©thode 2 - Contactez l\'administrateur avec votre num√©ro de t√©l√©phone',
          'warning'
        );
        return;
      }

      const identifier = document.getElementById('identifier').value.trim();
      
      if (!identifier) {
        addResult('‚ùå Veuillez entrer un num√©ro de t√©l√©phone ou email', 'error');
        return;
      }

      const btn = document.getElementById('diagBtn');
      btn.disabled = true;
      btn.textContent = 'üîç Diagnostic en cours...';

      try {
        addSection('üîç √âTAPE 1 : ANALYSE DE L\'IDENTIFIANT');
        
        const inputType = detectInputType(identifier);
        addResult(`Type d√©tect√©: ${inputType}`, 'info');
        
        let normalizedPhone = null;
        if (inputType === 'phone') {
          normalizedPhone = normalizePhoneNumber(identifier);
          addResult(`üì± Num√©ro normalis√©: ${normalizedPhone}`, 'info');
        }

        // Recherche via l'API backend
        addSection('üîç √âTAPE 2 : RECHERCHE DANS LE BACKEND');
        
        const apiUrl = `https://${window.projectId}.supabase.co/functions/v1/make-server-2eb02e52/diagnostic-driver`;
        
        addResult(`API URL: ${apiUrl}`, 'info');
        addResult(`Payload: ${JSON.stringify({ identifier: normalizedPhone || identifier }, null, 2)}`, 'info');
        
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${window.publicAnonKey}`
          },
          body: JSON.stringify({
            identifier: normalizedPhone || identifier
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        addSection('üìä R√âSULTAT DU DIAGNOSTIC BACKEND');
        addResult(JSON.stringify(result, null, 2), result.success ? 'success' : 'error');

        if (result.success && result.login_info) {
          addSection('‚úÖ COMPTE TROUV√â !');
          
          const info = result.login_info;
          addResult(
            `Email Auth: ${info.email_auth}\n` +
            `T√©l√©phone: ${info.phone}\n` +
            `User ID: ${info.user_id}\n` +
            `Nom: ${info.name}\n` +
            `R√¥le: ${info.role}`,
            'success'
          );
          
          addSection('üéØ INSTRUCTIONS DE CONNEXION');
          addResult(
            `Utilisez ces identifiants pour vous connecter √† l'app conducteur:\n\n` +
            `üìß Email: ${info.email_auth}\n` +
            `üîê Mot de passe: [votre mot de passe habituel]\n\n` +
            `‚ö†Ô∏è IMPORTANT: Utilisez l'EMAIL ci-dessus, PAS votre num√©ro de t√©l√©phone !\n\n` +
            `Si vous avez oubli√© votre mot de passe, utilisez "Mot de passe oubli√©" avec cet email.`,
            'warning'
          );

          // Test de connexion optionnel
          addSection('üß™ TEST DE CONNEXION (Optionnel)');
          addResult(
            `Voulez-vous tester la connexion maintenant ?\n\n` +
            `Rechargez cette page et utilisez le bouton de test ci-dessous avec:\n` +
            `- Email: ${info.email_auth}\n` +
            `- Mot de passe: [√† saisir]`,
            'info'
          );

        } else if (result.sql_fix) {
          // Email non confirm√©
          addSection('‚ö†Ô∏è EMAIL NON CONFIRM√â');
          addResult(
            `Votre compte existe mais l'email n'est pas confirm√©.\n\n` +
            `SQL √† ex√©cuter dans Supabase:\n${result.sql_fix}`,
            'warning'
          );
          
        } else {
          // Aucun compte trouv√©
          addSection('‚ùå AUCUN COMPTE TROUV√â');
          addResult(
            `Aucun compte n'a √©t√© trouv√© avec cet identifiant.\n\n` +
            `V√©rifications effectu√©es:\n` +
            `${result.results?.checks?.map(c => `- ${c.check}: ${c.status}`).join('\n') || 'N/A'}\n\n` +
            `Recommandation:\n${result.recommendation || 'Contactez l\'administrateur'}`,
            'error'
          );
        }

      } catch (error) {
        addSection('‚ùå ERREUR');
        addResult(
          `Erreur lors du diagnostic:\n\n` +
          `Message: ${error.message}\n\n` +
          `Stack:\n${error.stack}\n\n` +
          `V√©rifiez:\n` +
          `1. Que le serveur backend est d√©marr√©\n` +
          `2. Les logs de la console (F12)\n` +
          `3. Votre connexion internet`,
          'error'
        );
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîç Lancer le diagnostic complet';
      }
    }

    window.runFullDiagnostic = runFullDiagnostic;
  </script>
</body>
</html>
